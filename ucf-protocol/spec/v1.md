# UCF Protocol v1 (minimal, stable)

## Scope
This document defines the minimal, stable v1 layer of `ucf-protocol`. The v1 schema is **additive-only**:
new fields may be appended with new tags, but existing tags, semantics, and encodings MUST remain stable.

## Stability contract
- **Additive changes only.** New fields must use new tag numbers.
- **No renames or type changes** for existing fields.
- **Canonical encoding is deterministic** and must remain backward compatible.

## Canonical encoding (summary)
All v1 types defined below support canonical encoding with these rules:

- Fields are encoded in **ascending tag order**.
- Each field is encoded as: **tag (u16 BE) + length (u32 BE) + payload bytes**.
- Scalars are fixed width, big-endian: `u16`, `u32`, `u64`, `i32`.
- Strings and bytes are encoded as: **len (u32 BE) + bytes**.
- Optional fields are encoded as: **presence (u8) + value (if present)**.
- Repeated fields are encoded as: **count (u32 BE) + each value**, each value uses its own length prefix.
- Set-like repeated fields (e.g., IDs) are **sorted lexicographically** before encoding.
- Nested messages use their canonical encoding as the payload bytes.
- Decoding is strict: unknown tags and trailing bytes are rejected.

## Domain separation ids
Canonical encodings are referenced by commitment domains in `core/crates/ucf-commit`.
The v1 domain ids are:

| Domain | ID |
| --- | --- |
| ExperienceRecord | 1 |
| MicroMilestone | 2 |
| MesoMilestone | 3 |
| MacroMilestone | 4 |
| PolicyDecision | 5 |
| ProofEnvelope | 6 |
| ControlFrame | 7 |

## Type definitions

### ControlFrame
| Tag | Field | Type |
| --- | --- | --- |
| 1 | frame_id | string |
| 2 | issued_at_ms | u64 |
| 3 | decision | PolicyDecision? |
| 4 | evidence_ids | repeated string (sorted) |
| 5 | policy_id | string |

### ControlFrameNormalized
A normalized representation of `ControlFrame` where `evidence_ids` and `decision.constraint_ids` are
sorted and de-duplicated before encoding.

### PolicyDecision
| Tag | Field | Type |
| --- | --- | --- |
| 1 | kind | i32 (DecisionKind) |
| 2 | action | i32 (ActionCode) |
| 3 | rationale | string |
| 4 | confidence_bp | u32 |
| 5 | constraint_ids | repeated string (sorted) |

### ExperienceRecord
| Tag | Field | Type |
| --- | --- | --- |
| 1 | record_id | string |
| 2 | observed_at_ms | u64 |
| 3 | subject_id | string |
| 4 | payload | bytes |
| 5 | digest | Digest? |
| 6 | vrf_tag | VrfTag? |
| 7 | proof_ref | ProofRef? |

### Digest
| Tag | Field | Type |
| --- | --- | --- |
| 1 | algorithm | string |
| 2 | value | bytes |
| 3 | algo_id | u32? |
| 4 | domain | u32? |
| 5 | value_32 | bytes? |

### VrfTag
| Tag | Field | Type |
| --- | --- | --- |
| 1 | algorithm | string |
| 2 | proof | bytes |
| 3 | output | bytes |
| 4 | suite_id | u32? |
| 5 | domain | u32? |
| 6 | tag | bytes? |

### ProofRef
| Tag | Field | Type |
| --- | --- | --- |
| 1 | proof_id | string |
| 2 | algo_id | u32? |
| 3 | suite_id | u32? |
| 4 | opaque | bytes? |

### MicroMilestone
| Tag | Field | Type |
| --- | --- | --- |
| 1 | milestone_id | string |
| 2 | achieved_at_ms | u64 |
| 3 | label | string |

### MesoMilestone
| Tag | Field | Type |
| --- | --- | --- |
| 1 | milestone_id | string |
| 2 | achieved_at_ms | u64 |
| 3 | label | string |
| 4 | micro_milestone_ids | repeated string (sorted) |

### MacroMilestone
| Tag | Field | Type |
| --- | --- | --- |
| 1 | milestone_id | string |
| 2 | achieved_at_ms | u64 |
| 3 | label | string |
| 4 | meso_milestone_ids | repeated string (sorted) |

### ProofEnvelope
| Tag | Field | Type |
| --- | --- | --- |
| 1 | envelope_id | string |
| 2 | payload | bytes |
| 3 | payload_digest | Digest? |
| 4 | vrf_tags | repeated VrfTag (sorted by canonical bytes) |
| 5 | signature_ids | repeated string (sorted) |

### SpeechEvent
| Tag | Field | Type |
| --- | --- | --- |
| 1 | evidence_id | string |
| 2 | content | string |
| 3 | confidence_bp | u16 |
| 4 | rationale_commit | bytes? |

### ExternalSpeechMessage
Boundary representation of speech output, mapping 1:1 with `SpeechEvent` fields.

| Tag | Field | Type |
| --- | --- | --- |
| 1 | evidence_id | string |
| 2 | content | string |
| 3 | confidence_bp | u16 |
| 4 | rationale_commit | bytes? |
